{
  "aggs": {
    "Area": {
      "terms": {
        "field": "branch.areaName.keyword",
        "order": {
          "_count": "desc"
        },
        "size": 15
      },
      "aggs": {
        "Branch": {
          "terms": {
            "field": "branch.name.keyword",
            "order": {
              "_count": "desc"
            },
            "size": 150
          },
          "aggs": {
            "Channel": {
              "terms": {
                "field": "client.cn.keyword",
                "order": {
                  "_count": "desc"
                },
                "size": 5
              },
              "aggs": {
                "TimeRange": {
                  "date_range": {
                    "field": "trnx.trnxDate",
                    "ranges": [
                      {
                        "key" : "[[${PrevMonth}]]",
                        "from": "now-2M/M",
                        "to": "now-1M/M-1s"
                      },
                      {
                        "key" : "[[${Month}]]",
                        "from": "now-1M/M",
                        "to": "now/M-1s"
                      }
                    ],
                    "time_zone": "Asia/Calcutta"
                  },
                  "aggs": {
                    "LocalCommissionReceived": {
                      "sum": {
                        "field": "trnx.localCommRecv"
                      }
                    },
                    "ExchangeGain": {
                      "sum": {
                        "field": "trnx.exchangeGain"
                      }
                    },
                    "CoBankCharges": {
                      "sum": {
                        "field": "trnx.coBankCharges"
                      }
                    },
                    "LastDateOfTrnx": {
                      "max": {
                        "script": {
                          "source": "if (doc.containsKey('trnx.trnxDate') && !doc['trnx.trnxDate'].empty && !doc['trnx.trnxDate'].empty && doc['_type'].value == \"trnx\") {\n   if (doc['trnx.trnxStatus.keyword'].value == \"PAID\" || doc['trnx.trnxStatus.keyword'].value == \"DONE\" ) {\n       def d = doc['trnx.trnxDate'].value.dayOfMonth;\n       return d;\n   }\n   else {\n       return null;\n   }\n}\n",
                          "lang": "painless"
                        }
                      }
                    },
                    "CommissionReceived": {
                      "sum": {
                        "field": "trnx.commRecv"
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    }
  },
  "size": 0,
  "_source": {
    "excludes": []
  },
  "stored_fields": [
    "*"
  ],
  "script_fields": {
    "MonthDay": {
      "script": {
        "source": "if (doc.containsKey('trnx.trnxDate') && !doc['trnx.trnxDate'].empty && !doc['trnx.trnxDate'].empty && doc['_type'].value == \"trnx\") {\n   if (doc['trnx.trnxStatus.keyword'].value == \"PAID\" || doc['trnx.trnxStatus.keyword'].value == \"DONE\" ) {\n       def d = doc['trnx.trnxDate'].value.dayOfMonth;\n       return d;\n   }\n   else {\n       return null;\n   }\n}\n",
        "lang": "painless"
      }
    }
  },
  "docvalue_fields": [
    {
      "field": "@timestamp",
      "format": "date_time"
    },
    {
      "field": "customer.creationDate",
      "format": "date_time"
    },
    {
      "field": "customer.creationDateOnline",
      "format": "date_time"
    },
    {
      "field": "customer.dateOfBirth",
      "format": "date_time"
    },
    {
      "field": "customer.lastTransactionDate",
      "format": "date_time"
    },
    {
      "field": "customer.lastUpdateDate",
      "format": "date_time"
    },
    {
      "field": "customer.updateDate",
      "format": "date_time"
    },
    {
      "field": "trnx.creationDate",
      "format": "date_time"
    },
    {
      "field": "trnx.lastUpdateDate",
      "format": "date_time"
    },
    {
      "field": "trnx.trnxDate",
      "format": "date_time"
    },
    {
      "field": "trnx.trnxPaidDate",
      "format": "date_time"
    },
    {
      "field": "trnx.trnxSendDatetime",
      "format": "date_time"
    },
    {
      "field": "xrate.timestamp",
      "format": "date_time"
    }
  ],
  "query": {
    "bool": {
      "must": [],
      "filter": [
        {
          "match_all": {}
        },
        {
          "range": {
            "trnx.trnxDate": {
              "format": "strict_date_optional_time",
              "gte": "2018-08-06T04:52:28.339Z",
              "lte": "2019-11-06T04:52:28.339Z"
            }
          }
        }
      ],
      "should": [],
      "must_not": []
    }
  },
  "pivot" : [
  	{
	 "rows" : ["Area","Branch","Channel"],
	 "cols" : ["TimeRange"],
	 "vals" : ["sum LocalCommissionReceived","sum CommissionReceived","sum ExchangeGain","sum CoBankCharges", "sum _docs AS Trnx", "sum LastDateOfTrnx"],
	 "computed" : ["[[${PrevMonth}]]_Revenue=[[${PrevMonth}]]_LocalCommissionReceived + [[${PrevMonth}]]_CommissionReceived + [[${PrevMonth}]]_ExchangeGain - [[${PrevMonth}]]_CoBankCharges",
	 				"[[${PrevMonth}]]_RPT=[[${PrevMonth}]]_Revenue/[[${PrevMonth}]]_Trnx",
	 				"[[${PrevMonth}]]_RPD=[[${PrevMonth}]]_Revenue/[[${PrevMonth}]]_LastDateOfTrnx",
	 				"[[${Month}]]_Revenue=[[${Month}]]_LocalCommissionReceived + [[${Month}]]_CommissionReceived + [[${Month}]]_ExchangeGain - [[${Month}]]_CoBankCharges",
	 				"[[${Month}]]_RPT=[[${Month}]]_Revenue/[[${Month}]]_Trnx",
	 				"[[${Month}]]_RPD=[[${Month}]]_Revenue/[[${Month}]]_LastDateOfTrnx",
	 				"RPDdiff=[[${Month}]]_RPD - [[${PrevMonth}]]_RPD",
	 				"RevDiff=[[${Month}]]_Revenue - [[${PrevMonth}]]_Revenue"],
	 "colgroups" : [
	 	"[[${PrevMonth}]](Area,Branch,Channel,[[${PrevMonth}]]_Trnx,[[${PrevMonth}]]_Revenue,[[${PrevMonth}]]_RPT,[[${PrevMonth}]]_RPD)",
	 	"[[${Month}]](Area,Branch,Channel,[[${Month}]]_Trnx,[[${Month}]]_Revenue,[[${Month}]]_RPT,[[${Month}]]_RPD)",
	 	"Summary(Area,Branch,Channel,[[${PrevMonth}]]_Trnx,[[${PrevMonth}]]_Revenue,[[${PrevMonth}]]_RPT,[[${PrevMonth}]]_RPD,[[${Month}]]_Trnx,[[${Month}]]_Revenue,[[${Month}]]_RPT,[[${Month}]]_RPD,RPDdiff,RevDiff)"
	 	]
	} 
 ]
}
