{ 
  "aggs":{ 
    "Area":{ 
      "terms":{ 
        "field":"branch.areaName.keyword",
        "order":{ 
          "_count":"desc"
        },
        "size":15
      },
      "aggs":{ 
        "Branch":{ 
          "terms":{ 
            "field":"branch.name.keyword",
            "order":{ 
              "_count":"desc"
            },
            "size":150
          },
          "aggs":{ 
            "Channel":{ 
              "terms":{ 
                "field":"client.cn.keyword",
                "order":{ 
                  "_count":"desc"
                },
                "size":5
              },
              "aggs":{ 
                "TimeRange":{ 
                  "date_range":{ 
                    "field":"trnx.trnxDate",
                    "ranges":[ 
                      { 
                        "key":"[[${PrevMonth}]]",
                        "from":"now-12M/M",
                        "to":"now-6M/M-1s"
                      },
                      { 
                        "key":"[[${ThisMonth}]]",
                        "from":"now-6M/M",
                        "to":"now/M-1s"
                      }
                    ],
                    "time_zone":"Asia/Calcutta"
                  },
                  "aggs":{ 
                    "LocalCommissionReceivedorTPC":{ 
                      "sum":{ 
                        "script":{ 
                          "source":"if (doc.containsKey('trnx.trnxDate') && !doc['trnx.trnxDate'].empty && doc['_type'].value == \"trnx\") {\r\n\tif ((doc['trnx.tpcCommShare'].empty || !doc.containsKey('trnx.tpcCommShare')) && (doc.containsKey('trnx.localCommRecv') && !doc['trnx.localCommRecv'].empty)) {\r\n\t\treturn doc['trnx.localCommRecv'].value;\r\n\t} else if (doc.containsKey('trnx.tpcCommShare') && !doc['trnx.tpcCommShare'].empty) {\r\n\t\treturn doc['trnx.tpcCommShare'].value;\r\n\t}\r\n}\r\n",
                          "lang":"painless"
                        }
                      }
                    },
                    "CommissionReceived":{ 
                      "sum":{ 
                        "field":"trnx.commRecv"
                      }
                    },
                    "ExchangeGain":{ 
                      "sum":{ 
                        "field":"trnx.exchangeGain"
                      }
                    },
                    "CoBankCharges":{ 
                      "sum":{ 
                        "field":"trnx.coBankCharges"
                      }
                    },
                    "LastDateOfTrnx":{ 
                      "max":{ 
                        "script":{ 
                          "source":"if (doc.containsKey('trnx.trnxDate') && !doc['trnx.trnxDate'].empty && !doc['trnx.trnxDate'].empty && doc['_type'].value == \"trnx\") {\n   if (doc['trnx.trnxStatus.keyword'].value == \"PAID\" || doc['trnx.trnxStatus.keyword'].value == \"DONE\" ) {\n       def d = doc['trnx.trnxDate'].value.dayOfMonth;\n       return d;\n   }\n   else {\n       return null;\n   }\n}\n",
                          "lang":"painless"
                        }
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    }
  },
  "size":0,
  "_source":{ 
    "excludes":[ 

